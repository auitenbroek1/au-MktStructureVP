//@version=5
indicator("Market Structure & Volume Profile", shorttitle="MktStruct+VP", overlay=true)

// ==================== INPUTS ====================

// Market Structure Settings
lookbackLength = input.int(20, "Structure Lookback Length", minval=5, maxval=100, group="Market Structure")
showStructure = input.bool(true, "Show Market Structure", group="Market Structure")
showBOS = input.bool(true, "Show Break of Structure (BOS)", group="Market Structure")
showChoCh = input.bool(true, "Show Change of Character (ChoCh)", group="Market Structure")

// Volume Profile Settings
vpRows = input.int(24, "Volume Profile Rows", minval=10, maxval=100, group="Volume Profile")
vpLookback = input.int(100, "Volume Profile Lookback", minval=20, maxval=500, group="Volume Profile")
showVP = input.bool(true, "Show Volume Profile", group="Volume Profile")
showPOC = input.bool(true, "Show Point of Control", group="Volume Profile")
showVAH = input.bool(true, "Show Value Area High", group="Volume Profile")
showVAL = input.bool(true, "Show Value Area Low", group="Volume Profile")
vaPercent = input.float(70.0, "Value Area %", minval=50, maxval=95, step=5, group="Volume Profile")

// Color Settings
bosColor = input.color(color.new(color.blue, 50), "BOS Color", group="Colors")
chochColor = input.color(color.new(color.orange, 50), "ChoCh Color", group="Colors")
pocColor = input.color(color.new(color.yellow, 0), "POC Color", group="Colors")
vahColor = input.color(color.new(color.green, 70), "VAH Color", group="Colors")
valColor = input.color(color.new(color.red, 70), "VAL Color", group="Colors")
vpColor = input.color(color.new(color.gray, 80), "Volume Profile Color", group="Colors")

// ==================== MARKET STRUCTURE DETECTION ====================

// Detect swing highs and lows
swingHigh = ta.pivothigh(high, lookbackLength, lookbackLength)
swingLow = ta.pivotlow(low, lookbackLength, lookbackLength)

// Track higher highs/lows and lower highs/lows
var float lastHigh = na
var float lastLow = na
var int trend = 0  // 1 = uptrend, -1 = downtrend

// Update structure points
if not na(swingHigh)
    if na(lastHigh) or swingHigh > lastHigh
        lastHigh := swingHigh

if not na(swingLow)
    if na(lastLow) or swingLow < lastLow
        lastLow := swingLow

// Detect BOS and ChoCh
var bool isBOS = false
var bool isChoCh = false

if showStructure
    // Uptrend detection
    if not na(swingLow) and not na(lastLow)
        if swingLow > lastLow  // Higher low
            if trend == -1
                isChoCh := true  // Change from downtrend to uptrend
            else
                isBOS := true
            trend := 1

    // Downtrend detection
    if not na(swingHigh) and not na(lastHigh)
        if swingHigh < lastHigh  // Lower high
            if trend == 1
                isChoCh := true  // Change from uptrend to downtrend
            else
                isBOS := true
            trend := -1

// ==================== VOLUME PROFILE CALCULATION ====================

var float[] vpPriceArray = array.new_float(vpRows, 0)
var float[] vpVolumeArray = array.new_float(vpRows, 0)

// Calculate price range
highestPrice = ta.highest(high, vpLookback)
lowestPrice = ta.lowest(low, vpLookback)
priceRange = highestPrice - lowestPrice
rowHeight = priceRange / vpRows

// Reset arrays
if barstate.isfirst
    array.fill(vpVolumeArray, 0)

// Accumulate volume in price rows
if showVP and barstate.islast
    for i = 0 to vpLookback - 1
        if i < bar_index
            barHigh = high[i]
            barLow = low[i]
            barVolume = volume[i]

            // Find which rows this bar spans
            startRow = math.floor((barLow - lowestPrice) / rowHeight)
            endRow = math.floor((barHigh - lowestPrice) / rowHeight)

            startRow := math.max(0, math.min(vpRows - 1, startRow))
            endRow := math.max(0, math.min(vpRows - 1, endRow))

            // Distribute volume across rows
            rowCount = endRow - startRow + 1
            volumePerRow = barVolume / rowCount

            for row = startRow to endRow
                currentVolume = array.get(vpVolumeArray, row)
                array.set(vpVolumeArray, row, currentVolume + volumePerRow)
                array.set(vpPriceArray, row, lowestPrice + (row + 0.5) * rowHeight)

// Find POC (Point of Control) - highest volume row
var float pocPrice = na
var int pocRow = 0
if showVP and barstate.islast
    maxVolume = array.max(vpVolumeArray)
    for i = 0 to vpRows - 1
        if array.get(vpVolumeArray, i) == maxVolume
            pocRow := i
            pocPrice := array.get(vpPriceArray, i)
            break

// Calculate Value Area (70% of volume)
var float vahPrice = na
var float valPrice = na
if showVP and barstate.islast
    totalVolume = array.sum(vpVolumeArray)
    targetVolume = totalVolume * (vaPercent / 100)

    // Start from POC and expand up and down
    accumulatedVolume = array.get(vpVolumeArray, pocRow)
    upperRow = pocRow
    lowerRow = pocRow

    while accumulatedVolume < targetVolume and (upperRow < vpRows - 1 or lowerRow > 0)
        upperVolume = upperRow < vpRows - 1 ? array.get(vpVolumeArray, upperRow + 1) : 0
        lowerVolume = lowerRow > 0 ? array.get(vpVolumeArray, lowerRow - 1) : 0

        if upperVolume > lowerVolume and upperRow < vpRows - 1
            upperRow += 1
            accumulatedVolume += upperVolume
        else if lowerRow > 0
            lowerRow -= 1
            accumulatedVolume += lowerVolume
        else
            break

    vahPrice := array.get(vpPriceArray, upperRow)
    valPrice := array.get(vpPriceArray, lowerRow)

// ==================== PLOTTING ====================

// Plot structure points
plotshape(showStructure and not na(swingHigh), "Swing High", shape.triangledown, location.abovebar, color.new(color.red, 0), size=size.tiny)
plotshape(showStructure and not na(swingLow), "Swing Low", shape.triangleup, location.belowbar, color.new(color.green, 0), size=size.tiny)

// Plot BOS
plotshape(showBOS and isBOS and trend == 1, "BOS Up", shape.labelup, location.belowbar, bosColor, text="BOS", textcolor=color.white, size=size.small)
plotshape(showBOS and isBOS and trend == -1, "BOS Down", shape.labeldown, location.abovebar, bosColor, text="BOS", textcolor=color.white, size=size.small)

// Plot ChoCh
plotshape(showChoCh and isChoCh and trend == 1, "ChoCh Up", shape.labelup, location.belowbar, chochColor, text="ChoCh", textcolor=color.white, size=size.small)
plotshape(showChoCh and isChoCh and trend == -1, "ChoCh Down", shape.labeldown, location.abovebar, chochColor, text="ChoCh", textcolor=color.white, size=size.small)

// Plot Volume Profile levels
if showPOC and not na(pocPrice)
    line.new(bar_index - vpLookback, pocPrice, bar_index, pocPrice, color=pocColor, width=2, style=line.style_solid)
    label.new(bar_index, pocPrice, "POC", color=color.new(color.yellow, 80), textcolor=color.black, style=label.style_label_left, size=size.small)

if showVAH and not na(vahPrice)
    line.new(bar_index - vpLookback, vahPrice, bar_index, vahPrice, color=vahColor, width=1, style=line.style_dashed)
    label.new(bar_index, vahPrice, "VAH", color=color.new(color.green, 80), textcolor=color.white, style=label.style_label_left, size=size.tiny)

if showVAL and not na(valPrice)
    line.new(bar_index - vpLookback, valPrice, bar_index, valPrice, color=valColor, width=1, style=line.style_dashed)
    label.new(bar_index, valPrice, "VAL", color=color.new(color.red, 80), textcolor=color.white, style=label.style_label_left, size=size.tiny)

// Reset flags
if barstate.islast
    isBOS := false
    isChoCh := false

// ==================== ALERTS ====================

alertcondition(isBOS and trend == 1, "BOS Bullish", "Break of Structure - Bullish")
alertcondition(isBOS and trend == -1, "BOS Bearish", "Break of Structure - Bearish")
alertcondition(isChoCh and trend == 1, "ChoCh Bullish", "Change of Character - Bullish")
alertcondition(isChoCh and trend == -1, "ChoCh Bearish", "Change of Character - Bearish")
